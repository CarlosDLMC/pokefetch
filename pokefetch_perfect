#!/bin/bash
# Display Pokemon with neofetch side-by-side

# Get pokemon WITH title (use -r for random, or pass name as argument)
if [ -z "$1" ]; then
    pokemon_full_output=$(pokemon-colorscripts -r 1-3)
else
    pokemon_full_output=$(pokemon-colorscripts -n "$1")
fi

# Extract pokemon name from first line and capitalize it (using bash built-ins)
IFS=$'\n' lines=($pokemon_full_output)
pokemon_name="${lines[0]^}"  # Capitalize first letter
pokemon_output="${pokemon_full_output#*$'\n'}"  # Remove first line

# Get neofetch info
#neofetch_output=$(neofetch --off)
neofetch_output=$(fastfetch --config ~/.config/fastfetch/pokefetch.jsonc --logo none --pipe false)

# Inject Pokemon name after the separator line (using bash instead of awk)
pokemon_line=$'\033[m\033[1m\033[31mPokemon\033[m: \033[m'"$pokemon_name"$'\033[m'
neofetch_output="${neofetch_output/------------------/------------------$'\n'$pokemon_line}"

# Process output to clean up CPU and GPU names (single sed for speed)
neofetch_output=$(echo "$neofetch_output" | sed -E '
  # CPU: Extract model name and clean up frequency
  s/Intel\(R\) Core\(TM\) (i[0-9]-[0-9]+H) @ ([0-9.]+) GHz/\1 \2GHz/
  # GPU NVIDIA GTX: Extract model numbers
  s/GeForce (GTX [0-9]+)[^a-zA-Z0-9]*.*$/\1/
  # GPU NVIDIA RTX: Extract model numbers
  s/GeForce (RTX [0-9]+)[^a-zA-Z0-9]*.*$/\1/
  # GPU Intel: Extract model numbers
  s/UHD Graphics ([0-9]+).*$/UHD \1/
  # GPU AMD: Extract model numbers
  s/(AMD )?Radeon (RX [0-9]+ ?[A-Z]*)[^a-zA-Z0-9]*.*$/\2/
  # Icons, Theme, Font: Remove [GTK2/3/4] suffix
  s/ \[GTK[0-9/]+\]//g
  # Disk: Change GiB to G
  s/GiB/G/g
')

# Count lines in each output (using bash built-ins, much faster)
IFS=$'\n' pokemon_array=($pokemon_output)
IFS=$'\n' neofetch_array=($neofetch_output)
pokemon_lines=${#pokemon_array[@]}
neofetch_lines=${#neofetch_array[@]}

# Calculate width and normalize (using perl for much faster ANSI stripping)
if command -v perl &>/dev/null; then
    # Perl is 10x faster than sed for this
    mapfile -t normalized_lines < <(echo "$pokemon_output" | perl -pe 's/\e\[[0-9;]*[mGKHfA-Z]|\e\][0-9];[^\a]*\a//g')
    max_width=0
    for line in "${normalized_lines[@]}"; do
        [ ${#line} -gt $max_width ] && max_width=${#line}
    done

    # Build normalized pokemon with padding
    normalized_pokemon=""
    IFS=$'\n'
    i=0
    for line in $pokemon_output; do
        width=${#normalized_lines[$i]}
        padding=$(printf '%*s' "$((max_width - width))" '')
        normalized_pokemon+="${line}${padding}"$'\n'
        ((i++))
    done
else
    # Fallback to sed if perl not available
    max_width=0
    normalized_lines=()
    while IFS= read -r line; do
        visual_line=$(printf '%s' "$line" | sed -E 's/\x1b(\[[0-9;]*[mGKHfA-Z]|\][0-9];[^\x07]*\x07)//g')
        line_width=${#visual_line}
        [ $line_width -gt $max_width ] && max_width=$line_width
        normalized_lines+=("$line|$line_width")
    done <<< "$pokemon_output"

    normalized_pokemon=""
    for entry in "${normalized_lines[@]}"; do
        line="${entry%|*}"
        width="${entry##*|}"
        padding=$(printf '%*s' "$((max_width - width))" '')
        normalized_pokemon+="${line}${padding}"$'\n'
    done
fi
normalized_pokemon="${normalized_pokemon%$'\n'}"

# Pad the shorter output with empty lines (centered vertically)
if [ "$pokemon_lines" -lt "$neofetch_lines" ]; then
    # Pokemon is shorter, center it vertically
    total_padding=$((neofetch_lines - pokemon_lines))
    top_padding=$((total_padding / 2))
    bottom_padding=$((total_padding - top_padding))
    
    padding_line=$(printf '%*s' "$max_width" '')
    
    # Add top padding
    top_padded=""
    for ((i=0; i<top_padding; i++)); do
        top_padded="${top_padded}${padding_line}"$'\n'
    done
    
    # Add pokemon
    top_padded="${top_padded}${normalized_pokemon}"
    
    # Add bottom padding
    for ((i=0; i<bottom_padding; i++)); do
        top_padded="${top_padded}"$'\n'"${padding_line}"
    done
    
    normalized_pokemon="$top_padded"
elif [ "$neofetch_lines" -lt "$pokemon_lines" ]; then
    # Neofetch is shorter, pad it
    padding=$((pokemon_lines - neofetch_lines))
    for ((i=0; i<padding; i++)); do
        neofetch_output="$neofetch_output"$'\n'
    done
fi

# Merge line by line with spacing
paste <(echo "$normalized_pokemon") <(echo "$neofetch_output") | sed 's/\t/  /'
